#!/usr/bin/env ruby

SERVICE_URL = ARGV.shift || "http://www.apidoc.me"
ORG = "gilt"

def download(data)
  downloads = {}
  data.each do |service_name, map|
    map.each do |target, path|
      tmpfile = "/tmp/download-#{downloads.size}.tmp"
      cmd = "curl --silent #{SERVICE_URL}/#{ORG}/code/#{service_name}/latest/#{target} > #{tmpfile}"
      puts cmd
      system(cmd)
      downloads[tmpfile] = path
    end
  end
  downloads.each do |tmp, path|
    puts "diff #{tmp} #{path}"
  end
end

download("apidoc" => {
           "ruby_client" => "client-tests/ruby_client.rb",
           "play_2_3_client" => "generated/app/ApidocClient.scala",
           "play_2_x_json" => "core/src/main/scala/core/Generated.scala",
           "play_2_x_routes" => "api/conf/routes"
         },
         "apidoc-generator" => {
           "play_2_3_client" => "generated/app/GeneratorClient.scala"
         })
